"""Regression tests for the projection helpers in ``matching.validation``."""

from __future__ import annotations

import numpy as np
import pytest

from strava_competition.matching.validation import _project_onto_polyline

SEGMENT_POINTS = np.array(
    [
        [454768.3621340844, 5703947.594145699],
        [454763.4605871007, 5703947.196458857],
        [454758.76628924906, 5703945.474957279],
        [454754.0719913975, 5703943.753455702],
        [454749.3776935459, 5703942.031954125],
        [454744.68339569424, 5703940.310452548],
        [454739.98909784266, 5703938.58895097],
        [454735.29479999107, 5703936.8674493935],
        [454730.6005021394, 5703935.145947816],
        [454725.90620428784, 5703933.424446239],
        [454721.21190643625, 5703931.7029446615],
        [454716.5176085846, 5703929.981443084],
        [454711.823310733, 5703928.259941507],
        [454707.1290128814, 5703926.5384399295],
        [454702.4347150298, 5703924.816938353],
        [454697.7404171782, 5703923.095436775],
        [454693.04611932655, 5703921.373935198],
        [454688.35182147496, 5703919.652433621],
        [454683.6575236234, 5703917.930932044],
        [454678.96322577173, 5703916.209430466],
        [454674.26892792014, 5703914.48792889],
        [454669.57463006856, 5703912.766427312],
        [454664.8803322169, 5703911.044925734],
        [454660.1860343653, 5703909.323424158],
        [454655.49173651374, 5703907.60192258],
        [454650.7974386621, 5703905.880421003],
        [454646.0778489666, 5703904.294636042],
        [454641.0785710334, 5703904.209664599],
        [454636.0792931001, 5703904.124693155],
        [454631.0800151669, 5703904.039721712],
        [454626.0807372336, 5703903.954750269],
        [454621.0814593004, 5703903.869778825],
        [454616.08218136715, 5703903.784807382],
        [454611.0829034339, 5703903.699835938],
        [454606.0836255007, 5703903.614864495],
        [454601.0843475674, 5703903.529893052],
        [454596.0850696342, 5703903.444921608],
        [454591.0857917009, 5703903.359950165],
        [454586.0865137677, 5703903.2749787215],
        [454581.08723583445, 5703903.190007278],
        [454576.0879579012, 5703903.105035835],
        [454571.088679968, 5703903.020064391],
        [454566.0894020347, 5703902.935092948],
        [454561.0901241015, 5703902.850121505],
        [454556.0908461682, 5703902.765150061],
        [454551.091568235, 5703902.680178618],
        [454546.09229030175, 5703902.595207174],
        [454541.0930123685, 5703902.5102357315],
        [454536.0937344353, 5703902.425264288],
        [454531.094456502, 5703902.340292844],
        [454526.0951785688, 5703902.255321401],
        [454521.0959006355, 5703902.170349957],
        [454516.0966227023, 5703902.085378515],
        [454511.09734476905, 5703902.000407071],
        [454506.0980668358, 5703901.915435627],
        [454501.0987889026, 5703901.830464184],
        [454496.0995109693, 5703901.7454927405],
        [454491.1002330361, 5703901.660521298],
        [454486.1009551028, 5703901.575549854],
        [454481.1016771696, 5703901.49057841],
        [454476.10239923635, 5703901.405606967],
        [454476.5682768317, 5703904.872406668],
        [454478.67619122704, 5703909.4063560385],
        [454480.78410562244, 5703913.94030541],
        [454482.8920200178, 5703918.474254781],
        [454484.9999344132, 5703923.008204153],
        [454486.2489253463, 5703927.725874183],
        [454486.18018757063, 5703932.725401672],
        [454486.111449795, 5703937.724929161],
        [454486.04271201935, 5703942.724456651],
        [454485.97397424374, 5703947.72398414],
        [454485.9052364681, 5703952.72351163],
        [454485.83649869246, 5703957.7230391195],
        [454485.76776091685, 5703962.722566608],
        [454485.6990231412, 5703967.722094098],
        [454485.63028536557, 5703972.721621588],
        [454485.5615475899, 5703977.721149078],
        [454485.4928098143, 5703982.7206765665],
        [454485.66638433555, 5703987.6855399655],
        [454487.13409800595, 5703992.465269726],
        [454488.6018116764, 5703997.244999486],
        [454490.0695253468, 5704002.024729246],
        [454491.53723901726, 5704006.8044590065],
        [454493.0049526877, 5704011.584188767],
        [454494.4726663581, 5704016.363918527],
        [454495.94038002857, 5704021.143648287],
        [454497.40809369896, 5704025.9233780475],
        [454498.8758073694, 5704030.703107808],
        [454500.3435210399, 5704035.482837568],
        [454501.8112347103, 5704040.262567329],
        [454503.2789483807, 5704045.0422970895],
        [454504.7466620511, 5704049.82202685],
        [454506.2143757216, 5704054.60175661],
        [454507.68208939204, 5704059.38148637],
        [454509.14980306244, 5704064.1612161305],
        [454510.6175167329, 5704068.940945891],
        [454512.0852304033, 5704073.720675651],
        [454513.55294407374, 5704078.500405411],
        [454516.65884824656, 5704082.156490846],
        [454520.58935898053, 5704085.246973878],
        [454524.5198697145, 5704088.337456909],
        [454528.4503804485, 5704091.427939941],
        [454532.38089118246, 5704094.518422972],
        [454536.31140191643, 5704097.608906005],
        [454540.35320865497, 5704099.257634079],
        [454544.71146482247, 5704096.807000859],
        [454549.06972098997, 5704094.356367639],
        [454553.42797715747, 5704091.905734419],
        [454557.78623332496, 5704089.455101199],
        [454562.24438749626, 5704087.657196094],
        [454567.136101932, 5704088.692150142],
        [454572.0278163677, 5704089.727104189],
        [454576.91953080334, 5704090.762058236],
        [454581.42596852046, 5704091.427202388],
        [454580.19156768266, 5704086.581972304],
        [454578.9571668448, 5704081.736742219],
        [454577.722766007, 5704076.891512135],
        [454576.4883651692, 5704072.04628205],
        [454575.2539643314, 5704067.201051965],
        [454574.0195634936, 5704062.355821881],
    ],
    dtype=float,
)

ACTIVITY_POINT = np.array(
    [454467.52746651584, 5703894.779198319],
    dtype=float,
)


def test_project_onto_polyline_clamps_parameter() -> None:
    """Ensure projections clamp to the segment span instead of overshooting."""

    projections, offsets = _project_onto_polyline(
        ACTIVITY_POINT[np.newaxis, :], SEGMENT_POINTS
    )

    assert projections.shape == (1,)
    assert offsets.shape == (1,)
    assert offsets[0] == pytest.approx(10.836916662066454, abs=1e-9)
    assert projections[0] == pytest.approx(299.8965331501686, abs=1e-9)
